# The list of data files and grid can be specified on the command line
# i.e. recap my_first_script.recap "datafiles=/mydata/*.nc" "grid=/mydata/mygrid.g" "varlookup=/mydata/mylookup.txt"
config = recap_configuration()
config.data = file_list("*.nc")
config.grid = grid("nhemi_30_x4.g", "sem_np4")
config.lookup = variable_lookup("nhemi_lookup.txt")

# Output the data index associated with this configuration
config.data.output_csv("nhemi_data_index.csv")

# Surface pressure minima criteria
ps_min_criteria = parameter_list()
ps_min_criteria.var = "PS"
ps_min_criteria.mag = "200Pa"
ps_min_criteria.dist = "4.0deg"
ps_min_criteria.minmaxdist = "0.0deg"

# Warm core criteria
warm_core_criteria = parameter_list()
warm_core_criteria.var = "T(400hPa)"
warm_core_criteria.mag = "-0.4K"
warm_core_criteria.dist = "8.0deg"
warm_core_criteria.minmaxdist = "1.1deg"

# Wind magnitude (output)
wind_mag = variable("_VECMAG(U(850hPa),V(850hPa))")
wind_mag.outputop = "max"
wind_mag.dist = "4.0deg"

# Parameters for point_search
dcu_param = parameter_list()
dcu_param.searchbymin = "PS"
dcu_param.mergedist = "2.0deg"
dcu_param.closedcontourcmd = [ps_min_criteria, warm_core_criteria]
dcu_param.output = ["lat", "lon", "PS", "ZS", wind_mag]

candidates = point_search(config, dcu_param)

# Topography threshold for stitch_nodes
topo_threshold = parameter_list()
topo_threshold.var = "ZS"
topo_threshold.op = "<="
topo_threshold.value = "70.0m"
topo_threshold.number = 8

# Parameters for stitch_nodes
stitch_param = parameter_list()
stitch_param.range = "8.0deg"
stitch_param.minduration = 8
stitch_param.maxgap = 2
stitch_param.threshold = [topo_threshold]

cyclone_paths = stitch_nodes(config, stitch_param)

# Output cyclone_paths to a CSV file
cyclone_paths.output_csv("nhemi_cyclone_paths.csv")

